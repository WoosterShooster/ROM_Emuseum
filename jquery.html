<html>
<head>
	<meta charset="utf-8">
	<title>eMuseum Reporter</title>
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<h3>eMuseum Report</h3>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

	<section id="fetch">
		<input type="text" placeholder="Search eMuseum" id="term" />
		<button id="search">Search</button>
	</section>

	<section id="box_response"></section>
    <div id="header"></div>
	<div id="results"></div>

	<script>
	//	$.getJSON("https://jsonplaceholder.typicode.com/posts/1", function(json) {
	//		console.log(json);
	//	});

	$(document).ready(function(){

		var getResults = function(){
			var search_term = $('#term').val();
			var search_regexp = new RegExp(search_term, "i");
			console.log(search_regexp);

			if(search_term == ''){ 		//validate that they've entered something
				$('#box_response').html("<h2 class='loading'>Please enter something.</h2>");
				$('#results').empty();
				$('#header').empty();
			} else { //else continue
				$('#box_response').html("<h2 class='loading'>Loading results</h2>");
	//			$.getJSON("http://romtmsem/search/" + search_term + "/objects/json?callback=?", function(json) {
				$.getJSON("http://localhost/emuseum_report/" + search_term + "_search.txt", function(json) {
					//As long as there's something, create the output
					if (json != "Nothing found."){
			
						//start header and output
						var header = "<h3> You searched for: '" + search_term + "'</h3>";
						var output = "<table><tr><td><b>Object</b></td><td><b>Field</b></td><td><b>Value</b></td></tr>";
						console.log(json);
						file_data = json;
						console.log(file_data);

						//declare keys in order of eMuseum boost value
						var keys=["title", "people", "makerDisplay", "geography", "geoDisplay", "displayDate", 
						"beginDate", "endDate", "medium", "period", "dimensions", "invno", "creditline", 
						"exhHistory", "department", "collections", "classifications", "name", "names",
						"publicCaptionEntries"];

						//for each object in the file data...
						for (var i = 0; i < file_data.objects.length; i++){
							var match_found = false;

							//insert media if exists
							if (file_data.objects[i].mediaExistence.value == true){
								image_insert = "<br><img height=75px src='http://romtmsem" + file_data.objects[i].primaryMedia.value + "'>";
							} else { image_insert = ""; }

							for (var k = 0; k < keys.length; k++) {
								var key = keys[k]; //set the name of the key to a variable
								if (key in file_data.objects[i]) {  //if the object has something for the field "key"
									if (search_regexp.test(file_data.objects[i][key].value)) {	//and if the field "key" value contains the search term
										output+="<tr><td><a href='http://romtmsem/objects/" + file_data.objects[i].id.value +"'>" + file_data.objects[i].invno.value + "</a>" + image_insert +"</td><td>" + key + " </td><td>" + file_data.objects[i][key].value +"</td></tr>";
										match_found = true;
										break; // print line and go to the next object
									}
								}
							}
							if(!match_found){ //if no match found, it must be one of the fields currently excluded from the API
								output+="<tr><td><a href='http://romtmsem/objects/" + file_data.objects[i].id.value +"'>" + file_data.objects[i].invno.value + "</a></td><td>geog, dimensions, creditline, exhHistory, or description</td><td> <i>fields not available in API yet</i></td></tr>";
							}
						}

						output+="</table>"

						//add summary counts to header
						//numbers hard-coded for demo
						header +="<h4>Total results: 303</h4>"
						+"<h4>title: 5<br>"
						+"makerDisplay: 1<br>"
						+"medium: 219<br>"
						+"description: 80</h4>";

						document.getElementById("header").innerHTML=header;
						document.getElementById("results").innerHTML=output;

					} else {
						var output = '<h2 class="loading">No results found</h2>';
						document.getElementById("header").innerHTML=header;
						document.getElementById("results").innerHTML=output;
					}
				});
			}
			return false;
		}

		$('#search').click(getResults);
		$('#term').keyup(function(event){
			if(event.keyCode == 13){
				getResults();
			}
		});
	});
			
	</script>

</body>
</html>